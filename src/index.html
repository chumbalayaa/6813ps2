<!DOCTYPE html>

<!--
  COLLABORATORS:
    No Collaborators
  
-->
<html>

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Checkerboard</title>

<!-- Load style sheets -->
<link rel="stylesheet" type="text/css" href="mainLayout.css" />

<!-- Load any supplemental Javascript libraries here -->
<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="checker.js"></script>
<script type="text/javascript" src="boardEvent.js"></script>
<script type="text/javascript" src="board.js"></script>
<script type="text/javascript" src="rules.js"></script>

<script type="text/javascript">

//This script extracts parameters from the URL
//from jquery-howto.blogspot.com

    $.extend({
        getUrlVars : function() {
            var vars = [], hash;
            var hashes = window.location.href.slice(
                    window.location.href.indexOf('?') + 1).split('&');
            for ( var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        },
        getUrlVar : function(name) {
            return $.getUrlVars()[name];
        }
    });

    var DEFAULT_BOARD_SIZE = 8;

    //data model
    var board;
    var rules;
    var whoseTurn = "black";
    var gameOver = false;	
    var winner = "";

    var directionOf = function(color) {
      if (color == "black") {
        return -1;
      }
      return 1;
    }

    // Fill in this function to toggle the display for whose turn
    // The color parameter should be either "black" or "red"
    var toggleTurn = function(color) {
        if (color == 'black') {
            $("#turnDiv").css("background-color", "black");
            $("#turnDiv").text("Black Turn");
            whoseTurn = 'black';
        } else {
            $("#turnDiv").css("background-color", "red");
            $("#turnDiv").text("Red Turn");
            whoseTurn = 'red';
        }
    };


    // This allows the Javascript code inside this block to only run when the page
    // has finished loading in the browser.
    $(document).ready(function() {

        if ($.getUrlVar('size') && $.getUrlVar('size') >= 6) {
            board = new Board($.getUrlVar('size'));
            var numRed = $.getUrlVar('size'),
                numBlack = $.getUrlVar('size');
        } else {
            board = new Board(DEFAULT_BOARD_SIZE);
            var numRed = DEFAULT_BOARD_SIZE,
                numBlack = DEFAULT_BOARD_SIZE;
        }


	   rules = new Rules(board);


     	// Draw Board
        pixelSize = 400/board.boardSize;
        for (var j = 0; j < board.boardSize; j++) {
            for (var i = 0; i < board.boardSize; i ++) {
                if ((i+j)%2 == 0) {
                    $("#board").append("<div id="+i+","+j+" class='cell' style='width:"+pixelSize+"px; height:"+pixelSize+"px; background-color:#FFFFFF'></div>"); 
                } else {
                    $("#board").append("<div id="+i+","+j+" class='cell' style='width:"+pixelSize+"px; height:"+pixelSize+"px;'></div>"); 
                }  
            }
        }

        //Add checker picture
        var addChecker = function(event) {
            var i = event.details.checker.col;
            var j = event.details.checker.row;
            var color = event.details.checker.color;
            var id = i+','+j;
            var e = document.getElementById(id);
            if (color == 'black') {
                e.innerHTML = '<img src="./graphics/black-piece.png" style="width:'+pixelSize+'px;height:'+pixelSize+'px">'; 
            } else {
                e.innerHTML = '<img src="./graphics/red-piece.png" style="width:'+pixelSize+'px;height:'+pixelSize+'px">';
            }
        };

        // var endGame = function(winningColor) {
        //     winner = winningColor;
        //     gameOver = true;
        // };

        //Move checker picture
        var moveChecker = function(event) {
            var oID = event.details.fromCol+','+event.details.fromRow;
            var origin = document.getElementById(oID) 
            var dID = event.details.toCol+','+event.details.toRow;
            var destination = document.getElementById(dID) 
            origin.innerHTML = "";
            //Get checker Status
            var isKing = event.details.checker.isKing;
            var color = event.details.checker.color;
            if (color == 'black') {
                if (isKing) {
                    destination.innerHTML = '<img src="./graphics/black-king.png" style="width:'+pixelSize+'px;height:'+pixelSize+'px">'; 
                } else {
                    destination.innerHTML = '<img src="./graphics/black-piece.png" style="width:'+pixelSize+'px;height:'+pixelSize+'px">';  
                }
            } else {
                if (isKing) {
                    destination.innerHTML = '<img src="./graphics/red-king.png" style="width:'+pixelSize+'px;height:'+pixelSize+'px">'; 
                } else {
                    destination.innerHTML = '<img src="./graphics/red-piece.png" style="width:'+pixelSize+'px;height:'+pixelSize+'px">'; 
                }
                
            }
            drawArrow(event.details.fromCol, event.details.fromRow, event.details.toCol, event.details.toRow);
        };

        //Remove a checker picture
        var removeChecker = function(event) {
            var id = event.details.col+','+event.details.row;
            var e = document.getElementById(id);
            e.innerHTML = "";
            // if (event.details.checker.color == 'black') {
            //     numBlack -= 1;
            //     console.log("BLACK: "+numBlack);
            //     if (numBlack == 0) {
            //         endGame('red');
            //     }
            // } else {
            //     numRed -= 1;
            //     console.log("RED: "+numRed);
            //     if (numRed == 0) {
            //         endGame('black');
            //     }
            // }
        };

        var canvas = document.getElementById("theCanvas");
        var context = canvas.getContext("2d");

        var drawArrow = function(fromCol, fromRow, toCol, toRow) {
            context.clearRect(0, 0, canvas.width, canvas.height);

            //Style
            context.strokeStyle = '#ffff00';
            context.fillStyle = '#ffff00';

            //main line
            context.beginPath();
            context.moveTo((fromCol*pixelSize + pixelSize/2), (fromRow*pixelSize + pixelSize/2));
            context.lineTo((toCol*pixelSize + pixelSize/2), (toRow*pixelSize + pixelSize/2));
            context.lineWidth = 2;
            context.closePath();
            context.stroke();  
            //Draw triangle head    
            context.beginPath();
            var headlen = 12;
            var angle = Math.atan2(toRow-fromRow,toCol-fromCol);
            context.moveTo((toCol*pixelSize + pixelSize/2), (toRow*pixelSize + pixelSize/2));
            context.lineTo((toCol*pixelSize + pixelSize/2)-headlen*Math.cos(angle+Math.PI/6),(toRow*pixelSize + pixelSize/2)-headlen*Math.sin(angle+Math.PI/6));
            context.lineTo((toCol*pixelSize + pixelSize/2)-headlen*Math.cos(angle-Math.PI/6),(toRow*pixelSize + pixelSize/2)-headlen*Math.sin(angle-Math.PI/6));
            context.closePath();
            context.fill();
        };


        board.addEventListener('add',function (e) {
            addChecker(e);
        },true);

        board.addEventListener('move',function (e) {
            moveChecker(e);
        },true);

        board.addEventListener('remove',function (e) {
            //console.log(e);
            removeChecker(e);
        }, true);

        board.addEventListener('promote',function (e) {
            //console.log(e);
        },true);

        
        $("#btnNewGame").click(function(evt) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            toggleTurn('black');
            board.prepareNewGame();
        });

        $("#btnAutoMove").click(function(evt) {
          var playerColor = whoseTurn;
          var playerDirection = directionOf(playerColor);
          var result = rules.makeRandomMove(playerColor, playerDirection);
          if (result != null) {
            if (playerColor == 'black') {
              toggleTurn('red');
            } else {
              toggleTurn('black');
            }
          }
        });

        board.prepareNewGame();

    });
</script>


</head>

<body>

<table id="mainTable">
    <tr>
        <td id="navigation">
          <table>
			  <tr><td><div id="turnDiv">Black Turn</div></td></tr>
              <tr><td><input id="btnNewGame" type="button" name="new" value="New Game"/></td></tr>
              <tr><td><input id="btnAutoMove" type="button" name="new" value="Auto Move"/></td></tr>

            </table>
        </td>

        <td id="content">
			
				<!-- Your code here -->
                <canvas id="theCanvas" width="400" height="400" style="position:absolute;"></canvas>
                <div id="board"></div>          
            
        </td>
    </tr>

   </table>

</body>

</html>
